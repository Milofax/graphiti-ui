# ============================================
# Graphiti UI - Development Docker Compose
# ============================================
#
# Dieses Compose-File ist für lokale Entwicklung.
# Für Produktion siehe /v/graphiti/docker-compose.yml
#
# Starten:
#   docker compose -f docker-compose.example.yml up -d
#
# ============================================

services:
  # ============================================
  # FalkorDB - Graph Database
  # ============================================
  falkordb:
    image: falkordb/falkordb:latest
    container_name: dev-falkordb
    ports:
      - "6379:6379"   # Redis Protocol
      - "3000:3000"   # Browser UI
    environment:
      - REDIS_ARGS=--appendonly yes --save 60 1
      - BROWSER=1
    volumes:
      - falkordb_data:/var/lib/falkordb/data
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Graphiti MCP Server
  # ============================================
  graphiti-mcp:
    image: zepai/knowledge-graph-mcp:standalone
    container_name: dev-graphiti-mcp
    depends_on:
      falkordb:
        condition: service_healthy
    ports:
      - "8000:8000"
    environment:
      # Database
      - FALKORDB_URI=redis://falkordb:6379
      - FALKORDB_DATABASE=graphiti
      # LLM (anpassen!)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-ollama}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-http://host.docker.internal:11434/v1}
      - LLM_MODEL=${LLM_MODEL:-llama3}
      # Embedding
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-embed-text}
      - EMBEDDING_DIM=${EMBEDDING_DIM:-768}
      # Config
      - CONFIG_PATH=/app/mcp/config/config.yaml
    volumes:
      - ./config:/app/mcp/config:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Graphiti UI (dieses Projekt)
  # ============================================
  graphiti-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dev-graphiti-ui
    depends_on:
      - graphiti-mcp
    ports:
      - "8080:8080"
    environment:
      # API Endpoints
      - GRAPHITI_MCP_URL=http://graphiti-mcp:8000
      - GRAPHITI_MCP_CONTAINER=dev-graphiti-mcp
      - FALKORDB_BROWSER_URL=http://localhost:3000
      # FalkorDB Connection
      - FALKORDB_HOST=falkordb
      - FALKORDB_PORT=6379
      - FALKORDB_DATABASE=graphiti
      # LLM/Embedding (für Anzeige)
      - OLLAMA_API_URL=${OPENAI_BASE_URL:-http://host.docker.internal:11434/v1}
      - LLM_MODEL=${LLM_MODEL:-llama3}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-embed-text}
      - EMBEDDING_DIM=${EMBEDDING_DIM:-768}
      # Auth
      - ADMIN_USERNAME=admin
      - SECRET_KEY=dev-secret-key-change-in-production
      # Config
      - CONFIG_PATH=/config/config.yaml
    volumes:
      - ./config:/config
      - ./data:/app/data

volumes:
  falkordb_data:

# ============================================
# Hinweise
# ============================================
#
# 1. Vor dem Start config/config.yaml erstellen:
#    mkdir -p config
#    cp config.example.yaml config/config.yaml
#
# 2. LLM API konfigurieren:
#    - Für lokales Ollama: OPENAI_BASE_URL=http://host.docker.internal:11434/v1
#    - Für OpenAI: OPENAI_API_KEY=sk-xxx, OPENAI_BASE_URL=https://api.openai.com/v1
#
# 3. Browser öffnen:
#    - UI: http://localhost:8080
#    - FalkorDB Browser: http://localhost:3000
#    - MCP Health: http://localhost:8000/health
#
# 4. Erstes Login:
#    - Admin-Passwort wird beim ersten Start gesetzt
